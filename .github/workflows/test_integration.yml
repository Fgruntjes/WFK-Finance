name: Integration tests
on:
    pull_request:

jobs:
    deploy_slug:
        runs-on: ubuntu-latest
        steps:
            - uses: rlespinasse/github-slug-action@v4
            - id: environment
              run: echo "var=${{ env.GITHUB_REF_SLUG_URL }}" >> $GITHUB_OUTPUT
            - id: tag
              run: echo "var=${{ env.GITHUB_SHA_SHORT }}" >> $GITHUB_OUTPUT
        outputs:
            environment: ${{ steps.environment.outputs.var }}
            tag: ${{ steps.tag.outputs.var }}

    deploy:
        needs: deploy_slug
        uses: ./.github/workflows/deploy.yml
        secrets: inherit
        permissions:
            contents: read
            id-token: write
            pages: write
        with:
            environment: ${{ needs.deploy_slug.outputs.environment }}
            version: ${{ needs.deploy_slug.outputs.tag }}

    test:
        runs-on: ubuntu-latest
        timeout-minutes: 30
        needs: deploy
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-dotnet@v3
              with:
                  dotnet-version: 7.0
            - run: dotnet build App.Test
            - run: pwsh App.Test/bin/Debug/net7.0/playwright.ps1 install --with-deps
            - run: |
                  dotnet test App.Test \
                      --no-build \
                      --blame \
                      --blame-hang-timeout 2m
