name: Integration tests
on:
    pull_request:

jobs:
    deploy_slug:
        runs-on: ubuntu-latest
        steps:
            - uses: rlespinasse/github-slug-action@v4
            - id: environment
              run: echo "var=${{ env.GITHUB_REF_SLUG_URL }}" >> $GITHUB_OUTPUT
            - id: tag
              run: echo "var=${{ env.GITHUB_SHA_SHORT }}" >> $GITHUB_OUTPUT
        outputs:
            environment: ${{ steps.environment.outputs.var }}
            tag: ${{ steps.tag.outputs.var }}

    deploy:
        needs: deploy_slug
        uses: ./.github/workflows/deploy.yml
        secrets: inherit
        permissions:
            contents: read
            deployments: write
        with:
            environment: ${{ needs.deploy_slug.outputs.environment }}
            version: ${{ needs.deploy_slug.outputs.tag }}

    test:
        runs-on: ubuntu-latest
        container:
            image: mcr.microsoft.com/playwright/dotnet:v1.39.0-jammy

        timeout-minutes: 30
        needs:
            - deploy
            - deploy_slug
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-dotnet@v3
              with:
                  dotnet-version: 7.0
            - run: dotnet build App.Test
            - run: |
                  APP_DB_CONNECTION_STRING=$(echo "${APP_DB_CONNECTION_STRING_ENCRYPTED}" | base64 -d | openssl enc -pbkdf2 -a -d -salt -pass pass:"${GH_ENCRYPT_KEY}")
                  echo "::add-mask::${APP_DB_CONNECTION_STRING}"

                  export APP_DB_CONNECTION_STRING
                  dotnet test App.Test \
                      --no-build \
                      --blame \
                      --blame-hang-timeout 2m
              env:
                  APP_URL: ${{ needs.deploy.outputs.app_url }}
                  APP_ENVIRONMENT: ${{ needs.deploy_slug.outputs.environment }}
                  APP_DB_CONNECTION_STRING_ENCRYPTED: ${{ needs.deploy.outputs.app_db_connection_string }}
                  GH_ENCRYPT_KEY: ${{ secrets.GH_ENCRYPT_KEY }}
